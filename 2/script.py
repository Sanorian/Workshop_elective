import pandas as pd
import numpy as np

# ==============================================
# 1. СОЗДАНИЕ И ПРОСМОТР ДАННЫХ
# ==============================================

print("=" * 60)
print("1. СОЗДАНИЕ DATAFRAME")
print("=" * 60)

# Создаем DataFrame из словаря
data = {
    'Имя': ['Анна', 'Борис', 'Виктор', 'Галина', 'Дмитрий', 'Елена'],
    'Возраст': [25, 32, 28, 35, 41, 29],
    'Город': ['Москва', 'СПб', 'Москва', 'Казань', 'СПб', 'Москва'],
    'Зарплата': [75000, 120000, 85000, 95000, 150000, 82000],
    'Стаж': [2, 8, 4, 10, 15, 3]
}

df = pd.DataFrame(data)
print("Исходный DataFrame:")
print(df)

# Базовая информация о данных
print("\nИнформация о DataFrame:")
print(df.info())

print("\nСтатистическое описание:")
print(df.describe())

# ==============================================
# 2. ИНДЕКСАЦИЯ И ВЫБОРКА ДАННЫХ
# ==============================================

print("\n" + "=" * 60)
print("2. ВЫБОРКА ДАННЫХ")
print("=" * 60)

# Выбор колонки
print("\nКолонка 'Имя':")
print(df['Имя'])

# Выбор нескольких колонок
print("\nВыбор имени и зарплаты:")
print(df[['Имя', 'Зарплата']])

# Выбор строк по индексу (loc - по меткам, iloc - по позиции)
print("\nПервые 3 строки (iloc):")
print(df.iloc[0:3])

print("\nСтроки с 1 по 3 и колонки с 1 по 3:")
print(df.iloc[0:3, 0:3])

print("\nКонкретная ячейка (имя 3-го сотрудника):")
print(df.loc[2, 'Имя'])

# ==============================================
# 3. ФИЛЬТРАЦИЯ ДАННЫХ
# ==============================================

print("\n" + "=" * 60)
print("3. ФИЛЬТРАЦИЯ")
print("=" * 60)

# Фильтр по условию
print("\nСотрудники старше 30 лет:")
print(df[df['Возраст'] > 30])

print("\nСотрудники из Москвы с зарплатой > 80000:")
print(df[(df['Город'] == 'Москва') & (df['Зарплата'] > 80000)])

print("\nСотрудники из СПб или с зарплатой > 100000:")
print(df[(df['Город'] == 'СПб') | (df['Зарплата'] > 100000)])

# ==============================================
# 4. ОБРАБОТКА ДАННЫХ
# ==============================================

print("\n" + "=" * 60)
print("4. ОБРАБОТКА ДАННЫХ")
print("=" * 60)

# Добавление новой колонки
df['Зарплата_в_год'] = df['Зарплата'] * 12
print("\nDataFrame с годовой зарплатой:")
print(df)

# Применение функции к данным
df['Возрастная_категория'] = df['Возраст'].apply(
    lambda x: 'Молодой' if x < 30 else 'Средний' if x < 40 else 'Опытный'
)
print("\nС возрастными категориями:")
print(df[['Имя', 'Возраст', 'Возрастная_категория']])

# Сортировка
print("\nСортировка по возрасту (по убыванию):")
print(df.sort_values('Возраст', ascending=False))

# ==============================================
# 5. ГРУППИРОВКА И АГРЕГАЦИЯ
# ==============================================

print("\n" + "=" * 60)
print("5. ГРУППИРОВКА И АГРЕГАЦИЯ")
print("=" * 60)

# Группировка по городу
print("\nСредняя зарплата по городам:")
print(df.groupby('Город')['Зарплата'].mean())

print("\nСтатистика по городам (среднее и количество):")
print(df.groupby('Город').agg({
    'Зарплата': 'mean',
    'Возраст': 'mean',
    'Имя': 'count'
}).rename(columns={'Имя': 'Количество'}))

# ==============================================
# 6. РАБОТА С ПРОПУЩЕННЫМИ ДАННЫМИ
# ==============================================

print("\n" + "=" * 60)
print("6. РАБОТА С ПРОПУЩЕННЫМИ ДАННЫМИ")
print("=" * 60)

# Создаем копию и добавляем пропуски
df_with_na = df.copy()
df_with_na.loc[1, 'Зарплата'] = np.nan
df_with_na.loc[3, 'Город'] = np.nan

print("DataFrame с пропущенными данными:")
print(df_with_na)

print("\nКоличество пропусков в каждой колонке:")
print(df_with_na.isnull().sum())

# Заполнение пропусков
df_with_na['Зарплата'].fillna(df_with_na['Зарплата'].mean(), inplace=True)
df_with_na['Город'].fillna('Неизвестно', inplace=True)

print("\nПосле заполнения пропусков:")
print(df_with_na)

# ==============================================
# 7. СОХРАНЕНИЕ И ЗАГРУЗКА ДАННЫХ
# ==============================================

print("\n" + "=" * 60)
print("7. СОХРАНЕНИЕ ДАННЫХ")
print("=" * 60)

# Сохраняем в CSV
df.to_csv('employees.csv', index=False, encoding='utf-8')
print("Данные сохранены в файл 'employees.csv'")

# Загружаем обратно
df_loaded = pd.read_csv('employees.csv')
print("\nЗагруженные данные:")
print(df_loaded.head())

# ==============================================
# 8. РАСШИРЕННЫЕ ОПЕРАЦИИ
# ==============================================

print("\n" + "=" * 60)
print("8. РАСШИРЕННЫЕ ОПЕРАЦИИ")
print("=" * 60)

# Создаем второй DataFrame для демонстрации объединения
new_employees = pd.DataFrame({
    'Имя': ['Жанна', 'Захар'],
    'Возраст': [27, 33],
    'Город': ['Москва', 'Казань'],
    'Зарплата': [78000, 90000],
    'Стаж': [3, 7]
})

# Объединение DataFrames
df_combined = pd.concat([df, new_employees], ignore_index=True)
print("\nОбъединенный DataFrame (добавлены новые сотрудники):")
print(df_combined)

# Pivot table (сводная таблица)
print("\nСводная таблица - средняя зарплата по городам и возрастным категориям:")
pivot = pd.pivot_table(
    df_combined, 
    values='Зарплата', 
    index='Город', 
    columns='Возрастная_категория',
    aggfunc='mean',
    fill_value=0
)
print(pivot)

# ==============================================
# 9. ВИЗУАЛИЗАЦИЯ (если установлен matplotlib)
# ==============================================

print("\n" + "=" * 60)
print("9. БАЗОВАЯ ВИЗУАЛИЗАЦИЯ")
print("=" * 60)

try:
    import matplotlib.pyplot as plt
    
    # Гистограмма зарплат
    df_combined['Зарплата'].plot(kind='hist', bins=10, title='Распределение зарплат')
    plt.xlabel('Зарплата')
    plt.show()
    
    print("График построен!")
except ImportError:
    print("Matplotlib не установлен. Пропускаем визуализацию.")

# ==============================================
# 10. ПРИМЕР РЕАЛЬНОЙ ЗАДАЧИ
# ==============================================

print("\n" + "=" * 60)
print("10. ПРИМЕР РЕАЛЬНОЙ ЗАДАЧИ - АНАЛИЗ ПРОДАЖ")
print("=" * 60)

# Создаем данные о продажах
sales_data = {
    'Дата': pd.date_range(start='2024-01-01', periods=100, freq='D'),
    'Товар': np.random.choice(['Ноутбук', 'Телефон', 'Планшет', 'Монитор'], 100),
    'Количество': np.random.randint(1, 10, 100),
    'Цена': np.random.choice([50000, 30000, 20000, 25000], 100),
    'Регион': np.random.choice(['Центр', 'Север', 'Юг', 'Восток'], 100)
}

sales_df = pd.DataFrame(sales_data)
sales_df['Выручка'] = sales_df['Количество'] * sales_df['Цена']

print("\nПервые 5 записей о продажах:")
print(sales_df.head())

print("\nТоп-5 товаров по выручке:")
top_products = sales_df.groupby('Товар')['Выручка'].sum().sort_values(ascending=False)
print(top_products)

print("\nВыручка по регионам:")
print(sales_df.groupby('Регион')['Выручка'].sum())

print("\nДинамика продаж по дням (средняя выручка):")
print(sales_df.resample('W', on='Дата')['Выручка'].mean().head())

print("\n" + "=" * 60)
print("ГОТОВО! Pandas успешно продемонстрировал свои возможности")
print("=" * 60)